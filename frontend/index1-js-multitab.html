<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chess Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .tab-container {
            display: flex;
            border-bottom: 2px solid #ddd;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            background-color: #f9f9f9;
            margin-right: 5px;
        }
        .tab.active {
            background-color: white;
            border-top: 2px solid #000;
        }
        .tab-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: -1px;
        }
        .tab-content.active {
            display: block;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .button-container {
            float: right;
        }
        .button-container button {
            margin-left: 10px;
        }
        .locked {
        opacity: 0.5;
        pointer-events: none;
        }
        .round-container {
            margin-top: 20px;
        }
        .round-tab {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid #ddd;
            border-bottom: none;
            background-color: #f9f9f9;
            margin-right: 5px;
            display: inline-block;
        }
        .round-tab.active {
            background-color: white;
            border-top: 2px solid #000;
        }
        .round-content {
            display: none;
            padding: 20px;
            border: 1px solid #ddd;
            margin-top: -1px;
        }
        .round-content.active {
            display: block;
        }
    </style>
</head>
<body>

    <!-- Tabs -->
    <div class="tab-container">
        <div class="tab active" onclick="openTab('tab1')">Players</div>
        <div class="tab" onclick="openTab('tab2')">Pairing</div>
        <div class="tab" onclick="openTab('tab3')">Standing</div>
    </div>

    <!-- Tab 1: Add Player to Table -->
    <div id="tab1" class="tab-content active">
        <h2>Add Player to Table</h2>
        <input type="text" id="name" placeholder="Enter name" required>
        <input type="number" id="Elo" placeholder="Enter Elo" required>
        <button onclick="addToTable()">Add</button>
        <div class="button-container">
            <button onclick="sortPlayers()">Sort Players</button>
            <button onclick="randomizePlayers()">Randomize Players</button>
            <button onclick="clearTable()">Clear Table</button>
            <input type="file" id="csvFileInput" accept=".csv" style="display:none" onchange="importFromCSV(event)">
            <button onclick="document.getElementById('csvFileInput').click()">Import from CSV</button>
            <button onclick="exportToCSV()">Export to CSV</button>
            <button onclick="lockAndPairing()">Lock & Start Pairing</button>

        </div>

        <table id="dataTable">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Elo</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows will be added here -->
            </tbody>
        </table>
    </div>

    <!-- Tab 2: Pairing -->
    <div id="tab2" class="tab-content">
        <h2>Pairing</h2>
        <div id="roundTabs" class="round-container">
            <!-- Round tabs will be added here -->
        </div>
        <div id="roundContents">
            <!-- Round contents will be added here -->
        </div>
        <button onclick="nextRound()">Next Round</button>
    </div>

    <!-- Tab 3: Standing -->
    <div id="tab3" class="tab-content">
        <h2>Standing</h2>
        <p>Standing logic will be implemented here.</p>
    </div>

    <script>
        let players = []; // Store input data
        let rounds = []; // Store rounds data
        let currentRound = 1; //Store current round number

        function addToTable() {
            let name = document.getElementById("name").value;
            let Elo = document.getElementById("Elo").value;
            if (!Elo) {
                Elo = 1400; // Default Elo value
            }
            if (name && Elo) {
                let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
                let newRow = table.insertRow();

                let nameCell = newRow.insertCell(0);
                let EloCell = newRow.insertCell(1);
                let actionCell = newRow.insertCell(2);

                nameCell.textContent = name;
                EloCell.textContent = Elo;
                actionCell.innerHTML = '<button onclick="deleteRow(this)">Delete</button>';

                // Store in variable
                players.push({ name: name, Elo: Number(Elo) });

                // Clear input fields
                document.getElementById("name").value = "";
                document.getElementById("Elo").value = "";

            } else {
                alert("Please enter both name and Elo.");
            }
        }

        function deleteRow(button) {
            let row = button.parentNode.parentNode;
            let rowIndex = row.rowIndex - 1; // Adjust for header row
            players.splice(rowIndex, 1); // Remove from players array
            row.parentNode.removeChild(row); // Remove row from table

        }

        function sortPlayers() {
            players.sort((a, b) => b.Elo - a.Elo); // Sort players by Elo in descending order
            updateTable();
        }

        function randomizePlayers() {
            for (let i = players.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [players[i], players[j]] = [players[j], players[i]];
            }
            updateTable();
        }

        function clearTable() {
            let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
            table.innerHTML = ""; // Clear all rows
            players = []; // Clear players array
        }

        function exportToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,Name,Elo\n";
            players.forEach(player => {
                csvContent += `${player.name},${player.Elo}\n`;
            });
        
            let encodedUri = encodeURI(csvContent);
            let link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "players.csv");
            document.body.appendChild(link); // Required for FF
        
            link.click();
            document.body.removeChild(link); // Clean up
        }

        function importFromCSV(event) {
            const file = event.target.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const rows = text.split('\n').slice(1); // Skip header row
                rows.forEach(row => {
                    const [name, Elo] = row.split(',');
                    if (name && Elo) {
                        players.push({ name: name.trim(), Elo: Number(Elo.trim()) });
                    }
                });
                updateTable();
            };
            reader.readAsText(file);
        }

        function lockAndPairing() {
            // Disable input fields
            document.getElementById("name").disabled = true;
            document.getElementById("Elo").disabled = true;

            // Disable buttons
            document.querySelectorAll('.button-container button').forEach(button => {
                button.disabled = true;
            });
        
            // Optionally, add a visual indication that the table is locked
            document.getElementById("dataTable").classList.add('locked');
            
            // Add a "Bye" player if the number of players is odd
            if (players.length % 2 !== 0) {
                players.push({ name: "Bye", Elo: 1400 });
            }
            updateTable();

            // Generate pairings
            rounds = generateBergerPairings(players);
            createRoundTab();
        }

        function generateBergerPairings(players) {
            const n = players.length;
            const pairings = [];
            for (let round = 1; round < n; round++) {
                const roundPairings = [];
                for (let i = 0; i < n / 2; i++) {
                    const player1 = players[i];
                    const player2 = players[n - 1 - i];
                    roundPairings.push([player1, player2]);
                }
                players.splice(1, 0, players.pop());
                pairings.push(roundPairings);
            }
            return pairings;
        }

        function createRoundTab() {
            const roundTabs = document.getElementById("roundTabs");
            const roundContents = document.getElementById("roundContents");

            // Capture the current round number
            const roundNumber = currentRound;

            // Create round tab
            const roundTab = document.createElement("div");
            roundTab.className = "round-tab";
            roundTab.innerText = `Round ${roundNumber}`;
            roundTab.onclick = () => openRound(roundNumber); // Use captured round number
            roundTabs.appendChild(roundTab);

            // Create round content
            const roundContent = document.createElement("div");
            roundContent.className = "round-content";
            roundContent.id = `round${roundNumber}`;
            roundContent.innerHTML = `<h3>Round ${roundNumber}</h3>`;
            const table = document.createElement("table");
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Player 1</th>
                        <th>Player 2</th>
                        <th>Result</th>
                    </tr>
                </thead>
                <tbody>
                    ${rounds[roundNumber - 1].map(pair => `
                        <tr>
                            <td>${pair[0].name}</td>
                            <td>${pair[1].name}</td>
                            <td>
                                <select>
                                    <option value="" selected> - </option>
                                    <option value="1-0">1-0</option>
                                    <option value="0-1">0-1</option>
                                    <option value="0.5-0.5">Draw</option>
                                </select>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
            roundContent.appendChild(table);
            roundContents.appendChild(roundContent);
            
            openRound(roundNumber);
            currentRound++; // Increment the current round after creating the tab and content
        }

        function nextRound() {
        // Save results for the current round
        const roundContent = document.getElementById(`round${currentRound - 1}`);
        const results = roundContent.querySelectorAll('select');
        results.forEach((select, index) => {
            const result = select.value;
            const [player1Score, player2Score] = result.split('-').map(Number);
            rounds[currentRound - 2][index].result = { player1Score, player2Score };
        });


        createRoundTab();
        console.log('rounds:', rounds);

    }

        function openRound(roundNumber) {
            const roundTabs = document.querySelectorAll(".round-tab");
            const roundContents = document.querySelectorAll(".round-content");

            roundTabs.forEach(tab => tab.classList.remove("active"));
            roundContents.forEach(content => content.classList.remove("active"));

            console.log(document.querySelector(`.round-tab:nth-child(${roundNumber})`).classList.add("active"))
            document.querySelector(`.round-tab:nth-child(${roundNumber})`).classList.add("active");
            document.getElementById(`round${roundNumber}`).classList.add("active");
        }

        function updateTable() {
            let table = document.getElementById("dataTable").getElementsByTagName('tbody')[0];
            table.innerHTML = ""; // Clear existing rows

            players.forEach(player => {
                let newRow = table.insertRow();

                let nameCell = newRow.insertCell(0);
                let EloCell = newRow.insertCell(1);
                let actionCell = newRow.insertCell(2);

                nameCell.textContent = player.name;
                EloCell.textContent = player.Elo;
                actionCell.innerHTML = '<button onclick="deleteRow(this)">Delete</button>';
            });
        }

        function openTab(tabId) {
            let tabs = document.querySelectorAll('.tab-content');
            let tabButtons = document.querySelectorAll('.tab');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabButtons.forEach(tab => tab.classList.remove('active'));

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-container .tab[onclick="openTab('${tabId}')"]`).classList.add('active');
        }
    </script>

</body>
</html>